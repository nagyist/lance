name: Create Release Branch

on:
  workflow_dispatch:
    inputs:
      source_release_branch:
        description: 'Source release branch (optional, e.g., release/v1.3). Leave empty to create from main.'
        required: false
        type: string
        default: ''
      dry_run:
        description: 'Dry run (simulate without pushing)'
        required: true
        default: false
        type: boolean

jobs:
  create-release-branch:
    runs-on: ubuntu-latest
    outputs:
      rc_tag: ${{ steps.create_branch.outputs.RC_TAG }}
      rc_version: ${{ steps.create_branch.outputs.RC_VERSION }}
      release_branch: ${{ steps.create_branch.outputs.RELEASE_BRANCH }}
      main_version: ${{ steps.create_branch.outputs.MAIN_VERSION }}
      release_root_tag: ${{ steps.create_branch.outputs.RELEASE_ROOT_TAG }}
    steps:
    - name: Output Inputs
      run: echo "${{ toJSON(github.event.inputs) }}"

    - name: Check out repository
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.source_release_branch || 'main' }}
        token: ${{ secrets.LANCE_RELEASE_TOKEN }}
        fetch-depth: 0
        lfs: true

    - name: Setup release environment
      uses: ./.github/actions/setup-release-env

    - name: Create release branch
      id: create_branch
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        bash ci/create_release_branch.sh "${{ inputs.source_release_branch }}"

    - name: Push changes (if not dry run)
      if: ${{ !inputs.dry_run }}
      run: |
        git push origin "${{ steps.create_branch.outputs.RELEASE_BRANCH }}"
        git push origin "${{ steps.create_branch.outputs.RC_TAG }}"
        # When creating from main: push main and release root tag
        # When creating from release branch: push minor release root tag
        if [ -z "${{ inputs.source_release_branch }}" ]; then
          git push origin main
          # Push release root tag (may already exist remotely if created during beta publish)
          git push origin "${{ steps.create_branch.outputs.RELEASE_ROOT_TAG }}" || echo "Release root tag already exists remotely"
        else
          # Push minor release root tag if it was created
          if [ -n "${{ steps.create_branch.outputs.MINOR_RELEASE_ROOT_TAG }}" ]; then
            git push origin "${{ steps.create_branch.outputs.MINOR_RELEASE_ROOT_TAG }}"
          fi
        fi

    - name: Generate Release Notes (if not dry run)
      if: ${{ !inputs.dry_run }}
      id: rc_release_notes
      env:
        GH_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
      run: |
        PREVIOUS_TAG="${{ steps.create_branch.outputs.PREVIOUS_TAG }}"
        RC_TAG="${{ steps.create_branch.outputs.RC_TAG }}"

        if [ -n "${PREVIOUS_TAG}" ]; then
          echo "Generating release notes from ${PREVIOUS_TAG} to ${RC_TAG}"
          NOTES=$(python ci/generate_release_notes.py ${PREVIOUS_TAG} ${RC_TAG})
        else
          echo "No previous tag found, using automatic generation"
          NOTES=$(gh api repos/${{ github.repository }}/releases/generate-notes \
            -f tag_name="${RC_TAG}" \
            --jq .body)
        fi

        # Save to output
        echo "notes<<EOF" >> $GITHUB_OUTPUT
        echo "$NOTES" >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT

    - name: Create GitHub Pre-Release (if not dry run)
      if: ${{ !inputs.dry_run }}
      uses: softprops/action-gh-release@v2
      with:
        tag_name: ${{ steps.create_branch.outputs.RC_TAG }}
        name: ${{ steps.create_branch.outputs.RC_TAG }}
        draft: false
        prerelease: true
        body: ${{ steps.rc_release_notes.outputs.notes }}
        token: ${{ secrets.LANCE_RELEASE_TOKEN }}

    - name: Create GitHub Discussion for RC Vote (if not dry run)
      if: ${{ !inputs.dry_run }}
      id: create_discussion
      env:
        GH_TOKEN: ${{ secrets.LANCE_RELEASE_TOKEN }}
        GITHUB_REPOSITORY: ${{ github.repository }}
      run: |
        DISCUSSION_URL=$(bash ci/create_rc_discussion.sh \
          "${{ steps.create_branch.outputs.RC_TAG }}" \
          "${{ steps.create_branch.outputs.RC_VERSION }}" \
          "${{ steps.create_branch.outputs.RELEASE_BRANCH }}" \
          "${{ steps.create_branch.outputs.RELEASE_TYPE }}")
        echo "DISCUSSION_URL=$DISCUSSION_URL" >> $GITHUB_OUTPUT

    - name: Summary
      run: |
        echo "## Release Branch Creation Summary" >> $GITHUB_STEP_SUMMARY
        echo "" >> $GITHUB_STEP_SUMMARY
        echo "- **Target Version:** ${{ steps.create_branch.outputs.RC_VERSION }}" >> $GITHUB_STEP_SUMMARY
        echo "- **RC Tag:** ${{ steps.create_branch.outputs.RC_TAG }}" >> $GITHUB_STEP_SUMMARY
        echo "- **Release Branch:** ${{ steps.create_branch.outputs.RELEASE_BRANCH }}" >> $GITHUB_STEP_SUMMARY

        if [ -z "${{ inputs.source_release_branch }}" ]; then
          echo "- **Release Root Tag:** ${{ steps.create_branch.outputs.RELEASE_ROOT_TAG }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Main Version:** ${{ steps.create_branch.outputs.MAIN_VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Source Branch:** main (HEAD)" >> $GITHUB_STEP_SUMMARY
        else
          echo "- **Source Branch:** ${{ inputs.source_release_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Release Notes Base:** ${{ steps.create_branch.outputs.PREVIOUS_TAG }}" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.create_branch.outputs.MINOR_RELEASE_ROOT_TAG }}" ]; then
            echo "- **Minor Release Root Tag:** ${{ steps.create_branch.outputs.MINOR_RELEASE_ROOT_TAG }}" >> $GITHUB_STEP_SUMMARY
          fi
        fi
        echo "- **Dry Run:** ${{ inputs.dry_run }}" >> $GITHUB_STEP_SUMMARY

        if [ "${{ inputs.dry_run }}" == "true" ]; then
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "⚠️ This was a dry run. No changes were pushed." >> $GITHUB_STEP_SUMMARY
        else
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ Release candidate ${{ steps.create_branch.outputs.RC_TAG }} created!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Voting Discussion**: ${{ steps.create_discussion.outputs.DISCUSSION_URL }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**What happened:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Created release branch ${{ steps.create_branch.outputs.RELEASE_BRANCH }} at ${{ steps.create_branch.outputs.RC_TAG }}" >> $GITHUB_STEP_SUMMARY
          if [ -z "${{ inputs.source_release_branch }}" ]; then
            echo "2. Bumped main to ${{ steps.create_branch.outputs.MAIN_VERSION }} (unreleased)" >> $GITHUB_STEP_SUMMARY
          else
            echo "2. Created from ${{ inputs.source_release_branch }} (main unchanged)" >> $GITHUB_STEP_SUMMARY
          fi
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Next steps:**" >> $GITHUB_STEP_SUMMARY
          echo "1. Review and vote in the discussion thread" >> $GITHUB_STEP_SUMMARY
          echo "2. Test the RC artifacts" >> $GITHUB_STEP_SUMMARY
          echo "3. If issues found, fix on release branch and use create-rc workflow" >> $GITHUB_STEP_SUMMARY
          echo "4. If approved, use approve-rc workflow" >> $GITHUB_STEP_SUMMARY
        fi
